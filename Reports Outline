import java.io.FileWriter;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
 
 /**
 * The ReportGenerator class handles the generation of various financial reports
 * including monthly summaries, annual reports, and category-specific reports.
 * It can also export report data to CSV format and display results.
 * @author
 * Iman Hamby
 * */
 
public class ReportGenerator {

    /**
    * This is a placeholder constructor
    * */ 
    public ReportGenerator(){
        
    }


    /**
     * Generates a summary report of financial data for each month in the year.
     * 
     * @return A String representing the monthly financial summary report.
     * @author 
     * Wajih Chowdhury
     */
    public String generateMonthlySummary(Budget budget) {

        ReportFormatter formatter = new ReportFormatter();
        
        double[] monthlyIncome = new double[12];
        double[] monthlyExpenses = new double[12];
        
        List<Transactions> transactions = budget.getTransactions();
        
        for (Transactions t : transactions) {
            String date = t.getDate();         // e.g., "2025-03-14" or "03/14/2025"
            double amount = t.getAmount();

            int monthIndex = extractMonthIndex(date); // 0-based month index

            if (amount >= 0) {
                monthlyIncome[monthIndex] += amount;
            } else {
                monthlyExpenses[monthIndex] += -amount; // store expenses as positive
            }
        }

        String[][] table = new String[13][4]; //header and 12 months
        table[0][0] = "Month";
        table[0][1] = "Income";
        table[0][2] = "Expenses";
        table[0][3] = "Net";

        double totalIncome = 0.0;
        double totalExpenses = 0.0;

        for (int i = 0; i < 12; i++) {
            double income = monthlyIncome[i];
            double expenses = monthlyExpenses[i];
            double net = income - expenses;

            totalIncome += income;
            totalExpenses += expenses;

            table[i + 1][0] = String.valueOf(i + 1);
            table[i + 1][1] = formatter.formatCurrency(income);
            table[i + 1][2] = formatter.formatCurrency(expenses);
            table[i + 1][3] = formatter.formatCurrency(net);
        }

        String header = formatter.formatHeader(budget.getYear(), "Monthly");
        String body = formatter.alignColumns(table);
        
        return header + "\n" + formatter.alignColumns(table);
    }

    /**
     * Generates a comprehensive financial report for the entire year,
     * summarizing income, expenses, and overall balance.
     * 
     * @return formatted annual report string
     * @author 
     * Wajih Chowdhury
     */
    public String generateAnnualReport(Budget budget) {
    	
    	double totalIncome = 0.0;
    	double totalExpenses = 0.0;
    	
    	List<Transactions> transactions = budget.getTransactions();
        

        for (Transactions t : transactions) {
            double amount = t.getAmount();
            if (amount >= 0) {
                totalIncome += amount;
            } else {
                totalExpenses += -amount;
            }
        }

        double balance = totalIncome - totalExpenses;

        ReportFormatter formatter = new ReportFormatter();
        StringBuilder report = new StringBuilder();
        

        report.append(formatter.formatHeader(budget.getYear(), "Annual"))
              .append(System.lineSeparator()).append(System.lineSeparator());

        report.append("Total Income:   ")
              .append(formatter.formatCurrency(totalIncome))
              .append(System.lineSeparator());

        report.append("Total Expenses: ")
              .append(formatter.formatCurrency(totalExpenses))
              .append(System.lineSeparator());

        report.append("Net Balance:    ")
              .append(formatter.formatCurrency(balance))
              .append(System.lineSeparator());

        return report.toString();
    }

    /**
     * Generates a financial report grouped by categories, showing total amounts
     * spent or earned for each category.
     * @param budget the Budget object containing all transactions for a given year
     * @return A String representing the category-based financial report.
     * @author 
     * Wajih Chowdhury
     */
    public String generateCategoryReport(Budget budget) {
    	ReportFormatter formatter = new ReportFormatter();

        Map<String, Double> categoryTotals = new HashMap<>();
        List<Transactions> transactions = budget.getTransactions();


        for (Transactions t : transactions) {
            String category = t.getCategory();
            double amount = t.getAmount();

            // Treat expenses as positive values for reporting
            if (amount < 0) {
                amount = -amount;
            }

            categoryTotals.put(category, categoryTotals.getOrDefault(category, 0.0) + amount);
        }

        String[][] table = new String[categoryTotals.size() + 1][2];
        table[0][0] = "Category";
        table[0][1] = "Total";

        int row = 1;
        for (Map.Entry<String, Double> entry : categoryTotals.entrySet()) {
            table[row][0] = entry.getKey();
            table[row][1] = formatter.formatCurrency(entry.getValue());
            row++;
        }

        String header = formatter.formatHeader(budget.getYear(), "Category");
        String body = formatter.alignColumns(table);

        return header + System.lineSeparator() + body;
    }


    /**
     * Exports the annual report to a CSV-like text file.
     *
     * @param budget   the Budget to generate the annual report from
     * @return true if export succeeded, false otherwise
     * @author 
     * Wajih Chowdhury
     */
    public boolean exportToCSV(Budget budget, String filename) {
        FileWriter writer = null;
        try {
            writer = new FileWriter(filename);
            String annualReport = generateAnnualReport(budget);
            String[] lines = annualReport.split("\\R");

            for (String line : lines) {
                // Convert multiple spaces into commas for basic CSV structure
                String csvLine = line.trim().replaceAll("\\s{2,}", ",");
                writer.write(csvLine);
                writer.write(System.lineSeparator());
            }

            writer.flush();
            return true;
        } catch (IOException e) {
            return false;
        } finally {
            if (writer != null) {
                try {
                    writer.close();
                } catch (IOException e) {
                    // Ignore close errors for now
                }
            }
        }
    }

    /**
     * Displays all report types to the console in order.
     *@param budget the Budget object containing all transactions for a given year
     * @author 
     * Wajih Chowdhury
     */
    public void displayResults(Budget budget) {
        System.out.println(generateMonthlySummary(budget));
        System.out.println();
        System.out.println(generateAnnualReport(budget));
        System.out.println();
        System.out.println(generateCategoryReport(budget));
    }

    /**
     * Helper method to extract a 0-based month index from a date String.
     * This method assumes the date is in either "YYYY-MM-DD" or "MM/DD/YYYY" format.
     *
     * @param date the date String from a transaction
     * @return an integer in the range 0-11 representing the month index
     * @author
     * Wajih Chowdhury
     */
    private int extractMonthIndex(String date) {
        if (date == null || date.isEmpty()) {
            return 0;
        }

        try {
            if (date.contains("-")) {
                // Format: YYYY-MM-DD
                String[] parts = date.split("-");
                int month = Integer.parseInt(parts[1]);
                return Math.max(0, Math.min(11, month - 1));
            } else if (date.contains("/")) {
                // Format: MM/DD/YYYY
                String[] parts = date.split("/");
                int month = Integer.parseInt(parts[0]);
                return Math.max(0, Math.min(11, month - 1));
            }
        } catch (Exception e) {
            // Fallback to month 0 on any parse error
        }

        return 0;
    }
}

/**
 * The ReportFormatter class provides utility methods for formatting financial reports,
 * including currency formatting, text alignment, and report headers.
 * 
 * @author 
 * Wajih Chowdhury
 */
class ReportFormatter {
   /**
    * Private constructor for a static class.
    * @author Arif Hossain
    */
   private ReportFormatter() {}
   /**
    * The currency symbol used for formatting monetary values.
    * @author Arif Hossain
    */
   private static char symbolCurrency = '$';

   /**
    * The default width used for report table columns.
    * @author Arif Hossain
    */
   private int columnWidth = 15;

   /**
    * Formats a numerical value into a currency string representation.
    * 
    * @param amount The amount to be formatted.
    * @return A formatted String representing the amount as currency (e.g., "$123.45").
    * @author Arif Hossain
    */
   public static String formatCurrency(double amount) {
       return String.format("%s%.2f", symbolCurrency, amount);
   }

   /**
    * Aligns data into columns of a specified width for table-like display.
    * 
    * @param data A 2D array of Strings containing the data to align in columns.
    * @return A formatted String representing the aligned table data.
    * @author Arif Hossain
    */
   public static String alignColumns(String[][] data) {
	   String output = "";
	   for (String[] col : data) {
		   for (String item : col) {
			   output.concat(item + "\t");
		   }
		   output.concat("\n");
	   }
       return null;
   }

   /**
    * Creates a formatted header for a report that includes the year and type of report.
    * 
    * @param year The year for which the report is generated.
    * @param reportType The type of report (e.g., "Annual", "Monthly").
    * @return A formatted String representing the report header section.
    * @author Arif Hossain
    */
   public static String formatHeader(int year, String reportType) {
       return String.format("%s Report for %d", reportType, year);
   }
}
