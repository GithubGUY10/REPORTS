/**
 * The {@code Integration} class represents the main control unit of the system.
 * <p>
 * It provides menu navigation, coordinates operations between different
 * modules, and handles system startup and shutdown.
 *
 * @author Syed Faisel
 * @author Abdullah Zidan
 * @author Justin Jones
 * @author Mohammed Hossain
 */
public class Integration {
	/**
	 * Default constructor for Integration
	 */
	private java.util.Scanner scanner = new java.util.Scanner(System.in);
	private Account currentAccount = null;
	private boolean running = true;

	/**
	 * Displays the main menu options for the program.
	 * <p>
	 * Responsible for showing the user the available actions and routing them to a
	 * module based on their selection.
	 *
	 * precondition The system must be initialized before showing the menu.
	 * 
	 * @author TBD
	 */
	public void displayMenu() {
		System.out.println("===== Finance Manager =====");
		if (currentAccount == null) {
			System.out.println("1) Log In");
			System.out.println("2) Register");
			System.out.println("3) Exit");
		} else {
			System.out.println("1) Accounts");
			System.out.println("2) Load / Storage");
			System.out.println("3) Reports");
			System.out.println("4) Prediction Tools");
			System.out.println("5) Log Out");
			System.out.println("6) Exit");
		}
		System.out.print("Choose an option: ");
	}

	/**
	 * Integrates different parts of the system to work together.
	 * <p>
	 * This method will use a continuous loop to process user input and call the
	 * corresponding methods based on that input.
	 *
	 * precondition: All modules must be properly initialized and ready.
	 * 
	 * @author TBD
	 */
	public void integrateSystem() {
		while (running) {
			displayMenu();
			String input = scanner.next();
			try {
				int choice = Integer.parseInt(input);
				if (currentAccount == null) {
					switch (choice) {
					case 1:
						logIn();
						break;
					case 2: {
						Account a = new Account();
						a.registerAccount(scanner);
						break;
					}
					case 3:
						running = false;
						break;
					default:
						System.out.println("Invalid option");
					}
				} else {
					switch (choice) {
					case 1:
						callAccounts();
						break;
					case 2:
						callStorage();
						break;
					case 3:
						displayReports();
						break;
					case 4:
						callPrediction();
						break;
					case 5:
						logOut();
						break;
					case 6:
						running = false;
						break;
					default:
						System.out.println("Invalid option");
					}
				}
			} catch (NumberFormatException e) {
				System.out.println("Please enter a number.");
			}
		}
		System.out.println("Exiting Finance Manager. Goodbye.");

	}

	/**
	 * Safely shuts down the system.
	 * <p>
	 * This method closes any open modules, saves unsaved data, and ends the program
	 * execution properly.
	 *
	 * precondition: The program must be running before shutdown. postcondtion: all
	 * neccessary modules are closed
	 * 
	 * @author TBD
	 */
	public void logOut() {
		if (currentAccount != null) {
			currentAccount.logout();
			currentAccount = null;
		}
	}

	public void logIn() {
		Account acc = new Account();
		boolean success = acc.login(scanner);
		if (success) {
			currentAccount = acc;
			System.out.println("Logged in as " + currentAccount.getUsername());
		}
	}

	/**
	 * Handles account-related operations (create/update/retrieve).
	 * 
	 * @author TBD
	 */
	private void callAccounts() {
		if (currentAccount == null) {
			System.out.println("No user logged in.");
			return;
		}

		boolean inAccounts = true;
		while (inAccounts) {
			System.out.println("--- Account Menu ---");
			System.out.println("1) Change Password");
			System.out.println("2) Delete Account");
			System.out.println("3) Back");
			System.out.print("Choice: ");

			String input = scanner.next();
			int ch = -1;
			try {
				ch = Integer.parseInt(input);
			} catch (NumberFormatException e) {
				System.out.println("Enter a number.");
				continue;
			}

			switch (ch) {
			case 1:
				currentAccount.changePassword(scanner);
				break;
			case 2:
				currentAccount.deleteAccount(scanner);
				inAccounts = false;
				currentAccount = null;
				break;
			case 3:
				inAccounts = false;
				break;
			default:
				System.out.println("Invalid choice");
			}
		}
	}

	/**
	 * Displays the reports generated by the system.
	 * <p>
	 * This method is called after processing data or performing calculations. It
	 * shows summaries, results, or other useful information to the user.
	 *
	 * precondition: Reports must have been generated before calling this method.
	 * postcondtion: Displays the full report
	 * 
	 * @author TBD
	 */
	public void displayReports() {
		// ReportGenerator rep = new ReportGenerator();
		// rep.displayResults();
	}

	/**
	 * Performs prediction-related operations (analytics/model execution).
	 * 
	 * @author TBD
	 */
	private void callPrediction() {
		// PredictionModule predict = new PredictionModule();
		// PredictionModule.UserPredictions userPredictions = predict.new UserPredictions();

	}

	/**
	 * Handles storage-related operations (load/save).
	 * 
	 * @author TBD
	 */
	private void callStorage() {
		if (currentAccount == null) {
			System.out.println("No user logged in. Please log in to manage your files.");
			return;
		}

		boolean inStorage = true;
		while (inStorage) {
			System.out.println("--- Storage Menu ---");
			System.out.println("1) Upload / Link CSV File");
			System.out.println("2) List Linked Files");
			System.out.println("3) Delete Linked File");
			System.out.println("4) Back");
			System.out.print("Choice: ");

			String t = scanner.next();
			int choice = -1;
			try {
				choice = Integer.parseInt(t);
			} catch (NumberFormatException e) {
				System.out.println("Enter a number.");
				continue;
			}
			switch (choice) {
			case 1: {
				try {
					// Account handles validation and already calls CSVStorageManager.loadData
					String fileName = currentAccount.askUserFileName(scanner);
					if (fileName != null && !fileName.isBlank()) {
						System.out.println("Linked file: " + fileName);
					}
				} catch (Exception e) {
					System.err.println("Failed to upload/link file: " + e.getMessage());
				}
				break;
			}
			case 4:
				inStorage = false;
				break;
			default:
				System.out.println("Invalid choice");
			}
		}
	}

	public static void main(String[] args) {
		Integration app = new Integration();
		app.integrateSystem();
	}
}
